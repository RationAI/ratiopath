
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../../tiling/utils/">
      
      
        <link rel="next" href="../../parsers/asap/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>mask_builders - RatioPath</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mask-builders" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="RatioPath" class="md-header__button md-logo" aria-label="RatioPath" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            RatioPath
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              mask_builders
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4a5 5 0 0 0 5-5 5 5 0 0 0-5-5"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to system preference"  type="radio" name="__palette" id="__palette_2">
    
      <label class="md-header__button md-icon" title="Switch to system preference" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5M7 15a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/RationAI/ratiopath" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../learn/get-started/quick-start/" class="md-tabs__link">
          
  
  
    
  
  Learn

        </a>
      </li>
    
  

    
  

    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../tiling/annotations/" class="md-tabs__link">
          
  
  
    
  
  Reference

        </a>
      </li>
    
  

    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="RatioPath" class="md-nav__button md-logo" aria-label="RatioPath" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    RatioPath
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/RationAI/ratiopath" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Learn
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Learn
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" >
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    GET STARTED
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    GET STARTED
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1_1" >
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../../learn/get-started/quick-start/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_1_1" id="__nav_2_1_1_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_1_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Quick Start
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/get-started/quick-start/tiling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Building a Tiling Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/get-started/quick-start/annotations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Adding Annotation Coverage to Tiles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/get-started/quick-start/overlays/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Attaching Overlay Data to Image Tiles
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learn/get-started/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Tiling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tiling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tiling/annotations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    annotations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tiling/overlays/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    overlays
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tiling/read_slide_tile/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    read_slide_tile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tiling/tilers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    tilers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tiling/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" checked>
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Masks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Masks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    mask_builders
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    mask_builders
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-builders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Available Builders
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Available Builders">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#averagingscalaruniformtilednumpymaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AveragingScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AveragingScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maxscalaruniformtilednumpymaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaxScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaxScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscalingaveragingclippingnumpymemmapmaskbuilder2d" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.get_vips_scale_factors" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vips_scale_factors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.setup_memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_memory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="setup_memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscalingscalaruniformvalueconstantstridemaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingScalarUniformValueConstantStrideMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingScalarUniformValueConstantStrideMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choosing-a-mask-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing a Mask Builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordinate-system-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate System Notes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Parsers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Parsers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parsers/asap/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ASAPParser
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../parsers/geojson/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    GeoJSONParser
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Augmentations
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Augmentations
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../augmentations/estimate_stain_vectors/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    estimate_stain_vectors
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../augmentations/stain_augmentor/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    StainAugmentor
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Ray
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Ray
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ray/read_slides/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    read_slides
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ray/vips_tiff_datasink/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    VipsTiffDatasink
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../openslide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenSlide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#available-builders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Available Builders
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Available Builders">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#averagingscalaruniformtilednumpymaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AveragingScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AveragingScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maxscalaruniformtilednumpymaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaxScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        MaxScalarUniformTiledNumpyMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscalingaveragingclippingnumpymemmapmaskbuilder2d" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.get_vips_scale_factors" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_vips_scale_factors
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.setup_memory" class="md-nav__link">
    <span class="md-ellipsis">
      
        setup_memory
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="setup_memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#autoscalingscalaruniformvalueconstantstridemaskbuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingScalarUniformValueConstantStrideMaskBuilder
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        AutoScalingScalarUniformValueConstantStrideMaskBuilder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#choosing-a-mask-builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        Choosing a Mask Builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#coordinate-system-notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate System Notes
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="mask-builders">Mask Builders</h1>
<p>Mask builders are tools for assembling feature masks from neural network predictions or other tile-level data. They handle the complexity of combining overlapping tiles, scaling between coordinate spaces, and managing memory for large output masks.</p>
<h2 id="overview">Overview</h2>
<p>When processing whole-slide images with neural networks, you often need to:</p>
<ol>
<li>Extract tiles from a slide</li>
<li>Run inference to get predictions or features for each tile</li>
<li>Assemble these predictions back into a full-resolution mask</li>
</ol>
<p>Mask builders automate step 3, handling:</p>
<ul>
<li><strong>Coordinate transformation</strong>: Converting from tile coordinates to mask coordinates</li>
<li><strong>Overlap handling</strong>: Averaging or taking the maximum when tiles overlap</li>
<li><strong>Memory management</strong>: Using in-memory arrays or memory-mapped files for large masks</li>
<li><strong>Edge clipping</strong>: Removing boundary artifacts from tiles</li>
</ul>
<h2 id="available-builders">Available Builders</h2>
<h3 id="averagingscalaruniformtilednumpymaskbuilder">AveragingScalarUniformTiledNumpyMaskBuilder</h3>


<div class="doc doc-object doc-class">



<a id="ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="ratiopath.masks.mask_builders.storage.NumpyArrayMaskBuilderAllocatorMixin">NumpyArrayMaskBuilderAllocatorMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.ScalarUniformTiledMaskBuilder">ScalarUniformTiledMaskBuilder</span></code>, <code><span title="ratiopath.masks.mask_builders.aggregation.AveragingMaskBuilderMixin">AveragingMaskBuilderMixin</span></code></p>



        <p>Averaging scalar uniform tiled mask builder using numpy arrays as accumulators.</p>
<p>The tiles are uniformly expanded from scalar/vector values before being assembled into the mask.
The overlaps are averaged during finalization.
The tiles are expected to have constant extents and strides.
These can vary across dimensions (e.g. different width and height), but must not change across tiles.
See <code>ScalarUniformTiledMaskBuilder</code> for details.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask_extents</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial dimensions of the mask to build.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of channels in the scalar values to be assembled into the mask.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_extents</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extents of the tiles in mask space for each spatial dimension (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_strides</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strides of the tiles in mask space for each spatial dimension (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AveragingScalarUniformTiledNumpyMaskBuilder</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>
<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># load your pretrained model here</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AveragingScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">mask_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># for binary classification</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">vgg16_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># features has shape (B, channels)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>
<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AveragingScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">NumpyArrayMaskBuilderAllocatorMixin</span><span class="p">,</span>
    <span class="n">ScalarUniformTiledMaskBuilder</span><span class="p">,</span>
    <span class="n">AveragingMaskBuilderMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Averaging scalar uniform tiled mask builder using numpy arrays as accumulators.</span>

<span class="sd">    The tiles are uniformly expanded from scalar/vector values before being assembled into the mask.</span>
<span class="sd">    The overlaps are averaged during finalization.</span>
<span class="sd">    The tiles are expected to have constant extents and strides.</span>
<span class="sd">    These can vary across dimensions (e.g. different width and height), but must not change across tiles.</span>
<span class="sd">    See `ScalarUniformTiledMaskBuilder` for details.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_extents (tuple[int, int]): Spatial dimensions of the mask to build.</span>
<span class="sd">        channels (int): Number of channels in the scalar values to be assembled into the mask.</span>
<span class="sd">        mask_tile_extents (tuple[int, int]): Extents of the tiles in mask space for each spatial dimension (height, width).</span>
<span class="sd">        mask_tile_strides (tuple[int, int]): Strides of the tiles in mask space for each spatial dimension (height, width).</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import openslide</span>
<span class="sd">        from ratiopath.masks.mask_builders import (</span>
<span class="sd">            AveragingScalarUniformTiledNumpyMaskBuilder,</span>
<span class="sd">        )</span>
<span class="sd">        import matplotlib.pyplot as plt</span>

<span class="sd">        LEVEL = 3</span>
<span class="sd">        tile_extents = (512, 512)</span>
<span class="sd">        tile_strides = (256, 256)</span>
<span class="sd">        slide = openslide.OpenSlide(&quot;path/to/slide.mrxs&quot;)</span>
<span class="sd">        slide_extent_x, slide_extent_y = slide.dimensions[LEVEL]</span>
<span class="sd">        vgg16_model = load_vgg16_model(...)  # load your pretrained model here</span>
<span class="sd">        mask_builder = AveragingScalarUniformTiledNumpyMaskBuilder(</span>
<span class="sd">            mask_extents=(slide_extent_y, slide_extent_x),</span>
<span class="sd">            channels=1,  # for binary classification</span>
<span class="sd">            mask_tile_extents=tile_extents,</span>
<span class="sd">            mask_tile_strides=tile_strides,</span>
<span class="sd">        )</span>
<span class="sd">        for tiles, xs, ys in generate_tiles_from_slide(</span>
<span class="sd">            slide, LEVEL, tile_extents, tile_strides, batch_size=32</span>
<span class="sd">        ):</span>
<span class="sd">            # tiles has shape (B, C, H, W)</span>
<span class="sd">            features = vgg16_model.predict(tiles)  # features has shape (B, channels)</span>
<span class="sd">            # Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
<span class="sd">            coords_batch = np.stack([ys, xs], axis=0)</span>
<span class="sd">            mask_builder.update_batch(features, coords_batch)</span>
<span class="sd">        assembled_mask, overlap = mask_builder.finalize()</span>
<span class="sd">        plt.imshow(assembled_mask[0], cmap=&quot;gray&quot;, interpolation=&quot;nearest&quot;)</span>
<span class="sd">        plt.axis(&quot;off&quot;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">mask_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
            <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">mask_tile_strides</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.AveragingScalarUniformTiledNumpyMaskBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">mask_tile_extents</span><span class="p">,</span> <span class="n">mask_tile_strides</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">mask_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
        <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">mask_tile_strides</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Use case</strong>: You have scalar predictions (e.g., class probabilities) for each tile and want to create a mask where each prediction is uniformly expanded to fill the tile's footprint. Overlapping regions are averaged.</p>
<p><strong>Example</strong>: Creating a heatmap of tumor probability predictions.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AveragingScalarUniformTiledNumpyMaskBuilder</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Open slide and set up tiling parameters</span>
<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>

<span class="c1"># Load your model</span>
<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># load your pretrained model here</span>

<span class="c1"># Initialize mask builder</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AveragingScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">mask_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># for binary classification</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Process tiles</span>
<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">vgg16_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># features has shape (B, channels)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>

<span class="c1"># Finalize and visualize</span>
<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<hr />
<h3 id="maxscalaruniformtilednumpymaskbuilder">MaxScalarUniformTiledNumpyMaskBuilder</h3>


<div class="doc doc-object doc-class">



<a id="ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="ratiopath.masks.mask_builders.storage.NumpyArrayMaskBuilderAllocatorMixin">NumpyArrayMaskBuilderAllocatorMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.ScalarUniformTiledMaskBuilder">ScalarUniformTiledMaskBuilder</span></code>, <code><span title="ratiopath.masks.mask_builders.aggregation.MaxMaskBuilderMixin">MaxMaskBuilderMixin</span></code></p>



        <p>Max scalar uniform tiled mask builder using numpy arrays as accumulators.</p>
<p>The tiles are uniformly expanded from scalar/vector values before being assembled into the mask.
The maximum value is taken at each pixel position during updates, no finalisation is required.
The tiles are expected to have constant extents and strides.
These can vary across dimensions (e.g. different width and height), but must not change across tiles.
See <code>ScalarUniformTiledMaskBuilder</code> for details.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>mask_extents</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial dimensions of the mask to build.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of channels in the scalar values to be assembled into the mask.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_extents</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extents of the tiles in mask space for each spatial dimension (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_strides</code>
            </td>
            <td>
                  <code><span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strides of the tiles in mask space for each spatial dimension (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="n">MaxScalarUniformTiledNumpyMaskBuilder</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">rationai.explainability.model_probing</span> <span class="kn">import</span> <span class="n">HookedModule</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>
<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># load your pretrained model here</span>
<span class="n">hooked_model</span> <span class="o">=</span> <span class="n">HookedModule</span><span class="p">(</span>
    <span class="n">vgg16_model</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;backbone.9&quot;</span>
<span class="p">)</span>  <span class="c1"># example layer</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">MaxScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">mask_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>  <span class="c1"># for binary classification</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># outputs are not used directly</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">get_activations</span><span class="p">(</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>  <span class="c1"># shape (B, C, H, W)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>
<span class="p">(</span><span class="n">assembled_mask</span><span class="p">,)</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">MaxScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">NumpyArrayMaskBuilderAllocatorMixin</span><span class="p">,</span>
    <span class="n">ScalarUniformTiledMaskBuilder</span><span class="p">,</span>
    <span class="n">MaxMaskBuilderMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Max scalar uniform tiled mask builder using numpy arrays as accumulators.</span>

<span class="sd">    The tiles are uniformly expanded from scalar/vector values before being assembled into the mask.</span>
<span class="sd">    The maximum value is taken at each pixel position during updates, no finalisation is required.</span>
<span class="sd">    The tiles are expected to have constant extents and strides.</span>
<span class="sd">    These can vary across dimensions (e.g. different width and height), but must not change across tiles.</span>
<span class="sd">    See `ScalarUniformTiledMaskBuilder` for details.</span>

<span class="sd">    Args:</span>
<span class="sd">        mask_extents (tuple[int, int]): Spatial dimensions of the mask to build.</span>
<span class="sd">        channels (int): Number of channels in the scalar values to be assembled into the mask.</span>
<span class="sd">        mask_tile_extents (tuple[int, int]): Extents of the tiles in mask space for each spatial dimension (height, width).</span>
<span class="sd">        mask_tile_strides (tuple[int, int]): Strides of the tiles in mask space for each spatial dimension (height, width).</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import openslide</span>
<span class="sd">        from ratiopath.masks.mask_builders import MaxScalarUniformTiledNumpyMaskBuilder</span>
<span class="sd">        import matplotlib.pyplot as plt</span>
<span class="sd">        from rationai.explainability.model_probing import HookedModule</span>

<span class="sd">        LEVEL = 3</span>
<span class="sd">        tile_extents = (512, 512)</span>
<span class="sd">        tile_strides = (256, 256)</span>
<span class="sd">        slide = openslide.OpenSlide(&quot;path/to/slide.mrxs&quot;)</span>
<span class="sd">        slide_extent_x, slide_extent_y = slide.dimensions[LEVEL]</span>
<span class="sd">        vgg16_model = load_vgg16_model(...)  # load your pretrained model here</span>
<span class="sd">        hooked_model = HookedModule(</span>
<span class="sd">            vgg16_model, layer_name=&quot;backbone.9&quot;</span>
<span class="sd">        )  # example layer</span>
<span class="sd">        mask_builder = MaxScalarUniformTiledNumpyMaskBuilder(</span>
<span class="sd">            mask_extents=(slide_extent_y, slide_extent_x),</span>
<span class="sd">            channels=1,  # for binary classification</span>
<span class="sd">            mask_tile_extents=tile_extents,</span>
<span class="sd">            mask_tile_strides=tile_strides,</span>
<span class="sd">        )</span>
<span class="sd">        for tiles, xs, ys in generate_tiles_from_slide(</span>
<span class="sd">            slide, LEVEL, tile_extents, tile_strides, batch_size=32</span>
<span class="sd">        ):</span>
<span class="sd">            # tiles has shape (B, C, H, W)</span>
<span class="sd">            outputs = hooked_model.predict(tiles)  # outputs are not used directly</span>
<span class="sd">            features = hooked_model.get_activations(&quot;backbone.9&quot;)  # shape (B, C, H, W)</span>
<span class="sd">            # Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
<span class="sd">            coords_batch = np.stack([ys, xs], axis=0)</span>
<span class="sd">            mask_builder.update_batch(features, coords_batch)</span>
<span class="sd">        (assembled_mask,) = mask_builder.finalize()</span>
<span class="sd">        plt.imshow(assembled_mask[0], cmap=&quot;gray&quot;, interpolation=&quot;nearest&quot;)</span>
<span class="sd">        plt.axis(&quot;off&quot;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">        ```</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">mask_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
            <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">mask_tile_strides</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.MaxScalarUniformTiledNumpyMaskBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">mask_tile_extents</span><span class="p">,</span> <span class="n">mask_tile_strides</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">mask_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
        <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">mask_tile_strides</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Use case</strong>: Similar to the averaging builder, but takes the maximum value at each pixel instead of averaging. Useful when you want to preserve the strongest signal.</p>
<p><strong>Example</strong>: Creating activation maps from intermediate network layers.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="n">MaxScalarUniformTiledNumpyMaskBuilder</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">rationai.explainability.model_probing</span> <span class="kn">import</span> <span class="n">HookedModule</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>

<span class="c1"># Set up model with hooks to extract intermediate activations</span>
<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">hooked_model</span> <span class="o">=</span> <span class="n">HookedModule</span><span class="p">(</span><span class="n">vgg16_model</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>

<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">MaxScalarUniformTiledNumpyMaskBuilder</span><span class="p">(</span>
    <span class="n">mask_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">mask_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># outputs are not used directly</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">get_activations</span><span class="p">(</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>  <span class="c1"># shape (B, C, H, W)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>

<span class="p">(</span><span class="n">assembled_mask</span><span class="p">,)</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<hr />
<h3 id="autoscalingaveragingclippingnumpymemmapmaskbuilder2d">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</h3>


<div class="doc doc-object doc-class">



<a id="ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="ratiopath.masks.mask_builders.storage.NumpyMemMapMaskBuilderAllocatorMixin">NumpyMemMapMaskBuilderAllocatorMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.AutoScalingConstantStrideMixin">AutoScalingConstantStrideMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.EdgeClippingMaskBuilder2DMixin">EdgeClippingMaskBuilder2DMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.aggregation.AveragingMaskBuilderMixin">AveragingMaskBuilderMixin</span></code></p>



        <p>Averaging mask builder with edge clipping using numpy memmaps as accumulators.</p>
<p>This concrete builder combines three features:
1. <strong>Memory-mapped storage:</strong> Handles large masks that exceed RAM capacity
2. <strong>Edge clipping:</strong> Removes boundary artifacts from tiles
3. <strong>Averaging:</strong> Smoothly blends overlapping tiles by computing pixel-wise averages</p>
<p>The builder allocates two memmaps:
- Main accumulator for tile data
- Overlap counter (can be specified via overlap_counter_filepath, or auto-derived with <code>.overlaps</code> suffix if accumulator_filepath is provided)</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial dimensions of the source space (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_tile_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extents of tiles in the source space (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_tile_strides</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Strides between tiles in the source space (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Extents of tiles in the mask space (height, width).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of channels in the tiles/mask.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>clip</code>
            </td>
            <td>
                  <code><span title="int">int</span> | <span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>] | <span title="tuple">tuple</span>[<span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>, <span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Edge clipping specification. Accepts:
- int: same clipping on all edges
- (clip_y, clip_x): same for top/bottom and left/right
- (clip_top, clip_bottom, clip_left, clip_right): individual edge control</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>accumulator_filepath</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path for the main accumulator memmap. If None, uses temporary file.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>overlap_counter_filepath</code>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span> | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional path for the overlap counter memmap. If None, derives from accumulator_filepath with <code>.overlaps</code> suffix.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">rationai.explainability.model_probing</span> <span class="kn">import</span> <span class="n">HookedModule</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>
<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># load your pretrained model here</span>
<span class="n">hooked_model</span> <span class="o">=</span> <span class="n">HookedModule</span><span class="p">(</span>
    <span class="n">vgg16_model</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;backbone.9&quot;</span>
<span class="p">)</span>  <span class="c1"># example layer</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</span><span class="p">(</span>
    <span class="n">source_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># output resolution per tile</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># for RGB masks</span>
    <span class="n">clip</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># clip 4 pixels from each edge</span>
<span class="p">)</span>
<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">vgg16_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># outputs are not used directly</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">get_activations</span><span class="p">(</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>  <span class="c1"># shape (B, C, H, W)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>
<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</span><span class="p">(</span>
    <span class="n">NumpyMemMapMaskBuilderAllocatorMixin</span><span class="p">,</span>
    <span class="n">AutoScalingConstantStrideMixin</span><span class="p">,</span>
    <span class="n">EdgeClippingMaskBuilder2DMixin</span><span class="p">,</span>
    <span class="n">AveragingMaskBuilderMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Averaging mask builder with edge clipping using numpy memmaps as accumulators.</span>

<span class="sd">    This concrete builder combines three features:</span>
<span class="sd">    1. **Memory-mapped storage:** Handles large masks that exceed RAM capacity</span>
<span class="sd">    2. **Edge clipping:** Removes boundary artifacts from tiles</span>
<span class="sd">    3. **Averaging:** Smoothly blends overlapping tiles by computing pixel-wise averages</span>

<span class="sd">    The builder allocates two memmaps:</span>
<span class="sd">    - Main accumulator for tile data</span>
<span class="sd">    - Overlap counter (can be specified via overlap_counter_filepath, or auto-derived with `.overlaps` suffix if accumulator_filepath is provided)</span>

<span class="sd">    Args:</span>
<span class="sd">        source_extents: Spatial dimensions of the source space (height, width).</span>
<span class="sd">        source_tile_extents: Extents of tiles in the source space (height, width).</span>
<span class="sd">        source_tile_strides: Strides between tiles in the source space (height, width).</span>
<span class="sd">        mask_tile_extents: Extents of tiles in the mask space (height, width).</span>
<span class="sd">        channels: Number of channels in the tiles/mask.</span>
<span class="sd">        clip: Edge clipping specification. Accepts:</span>
<span class="sd">            - int: same clipping on all edges</span>
<span class="sd">            - (clip_y, clip_x): same for top/bottom and left/right</span>
<span class="sd">            - (clip_top, clip_bottom, clip_left, clip_right): individual edge control</span>
<span class="sd">        accumulator_filepath: Optional path for the main accumulator memmap. If None, uses temporary file.</span>
<span class="sd">        overlap_counter_filepath: Optional path for the overlap counter memmap. If None, derives from accumulator_filepath with `.overlaps` suffix.</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import openslide</span>
<span class="sd">        from ratiopath.masks.mask_builders import (</span>
<span class="sd">            AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D,</span>
<span class="sd">        )</span>
<span class="sd">        from rationai.explainability.model_probing import HookedModule</span>
<span class="sd">        import matplotlib.pyplot as plt</span>

<span class="sd">        LEVEL = 3</span>
<span class="sd">        tile_extents = (512, 512)</span>
<span class="sd">        tile_strides = (256, 256)</span>
<span class="sd">        slide = openslide.OpenSlide(&quot;path/to/slide.mrxs&quot;)</span>
<span class="sd">        slide_extent_x, slide_extent_y = slide.level_dimensions[LEVEL]</span>
<span class="sd">        vgg16_model = load_vgg16_model(...)  # load your pretrained model here</span>
<span class="sd">        hooked_model = HookedModule(</span>
<span class="sd">            vgg16_model, layer_name=&quot;backbone.9&quot;</span>
<span class="sd">        )  # example layer</span>
<span class="sd">        mask_builder = AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D(</span>
<span class="sd">            source_extents=(slide_extent_y, slide_extent_x),</span>
<span class="sd">            source_tile_extents=tile_extents,</span>
<span class="sd">            source_tile_strides=tile_strides,</span>
<span class="sd">            mask_tile_extents=(64, 64),  # output resolution per tile</span>
<span class="sd">            channels=3,  # for RGB masks</span>
<span class="sd">            clip=(4, 4, 4, 4),  # clip 4 pixels from each edge</span>
<span class="sd">        )</span>
<span class="sd">        for tiles, xs, ys in generate_tiles_from_slide(</span>
<span class="sd">            slide, LEVEL, tile_extents, tile_strides, batch_size=32</span>
<span class="sd">        ):</span>
<span class="sd">            # tiles has shape (B, C, H, W)</span>
<span class="sd">            output = vgg16_model.predict(tiles)  # outputs are not used directly</span>
<span class="sd">            features = hooked_model.get_activations(&quot;backbone.9&quot;)  # shape (B, C, H, W)</span>
<span class="sd">            # Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
<span class="sd">            coords_batch = np.stack([ys, xs], axis=0)</span>
<span class="sd">            mask_builder.update_batch(features, coords_batch)</span>
<span class="sd">        assembled_mask, overlap = mask_builder.finalize()</span>
<span class="sd">        plt.imshow(assembled_mask[0], cmap=&quot;gray&quot;, interpolation=&quot;nearest&quot;)</span>
<span class="sd">        plt.axis(&quot;off&quot;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">        ```</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">source_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">source_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">clip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
        <span class="n">accumulator_filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">overlap_counter_filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">source_extents</span><span class="o">=</span><span class="n">source_extents</span><span class="p">,</span>
            <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">source_tile_extents</span><span class="p">,</span>
            <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">source_tile_strides</span><span class="p">,</span>
            <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
            <span class="n">accumulator_filepath</span><span class="o">=</span><span class="n">accumulator_filepath</span><span class="p">,</span>
            <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="n">overlap_counter_filepath</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">setup_memory</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask_extents</span><span class="p">,</span>
        <span class="n">channels</span><span class="p">,</span>
        <span class="n">accumulator_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accumulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_accumulator</span><span class="p">(</span>
            <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="n">accumulator_filepath</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">overlap_counter_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">counter_filepath</span> <span class="o">=</span> <span class="n">overlap_counter_filepath</span>
        <span class="k">elif</span> <span class="n">accumulator_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="n">accumulator_filepath</span><span class="o">.</span><span class="n">suffix</span>
            <span class="n">counter_filepath</span> <span class="o">=</span> <span class="n">accumulator_filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.overlaps</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">counter_filepath</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overlap_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_accumulator</span><span class="p">(</span>
            <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="n">counter_filepath</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_vips_scale_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the scaling factors to convert the built mask back to the original source resolution.</span>

<span class="sd">        The idea is to obtain coefficients for the pyvips.affine() function to rescale the assembled mask</span>
<span class="sd">        back to the original source resolution after assembly and finalization.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple[float, float]: Scaling factors for height and width dimensions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scale_factors</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">overflow_buffered_source_extents</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">accumulator</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">)</span>  <span class="c1"># H, W</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scale_factors</span><span class="p">)</span>  <span class="c1"># TODO: add tests for this method</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">source_extents</span><span class="p">,</span> <span class="n">source_tile_extents</span><span class="p">,</span> <span class="n">source_tile_strides</span><span class="p">,</span> <span class="n">mask_tile_extents</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">accumulator_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">source_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">source_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">clip</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
    <span class="n">accumulator_filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlap_counter_filepath</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">source_extents</span><span class="o">=</span><span class="n">source_extents</span><span class="p">,</span>
        <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">source_tile_extents</span><span class="p">,</span>
        <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">source_tile_strides</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="n">clip</span><span class="o">=</span><span class="n">clip</span><span class="p">,</span>
        <span class="n">accumulator_filepath</span><span class="o">=</span><span class="n">accumulator_filepath</span><span class="p">,</span>
        <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="n">overlap_counter_filepath</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.get_vips_scale_factors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_vips_scale_factors</span><span class="p">()</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Get the scaling factors to convert the built mask back to the original source resolution.</p>
<p>The idea is to obtain coefficients for the pyvips.affine() function to rescale the assembled mask
back to the original source resolution after assembly and finalization.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="tuple">tuple</span>[<span title="float">float</span>, <span title="float">float</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>tuple[float, float]: Scaling factors for height and width dimensions.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">get_vips_scale_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the scaling factors to convert the built mask back to the original source resolution.</span>

<span class="sd">    The idea is to obtain coefficients for the pyvips.affine() function to rescale the assembled mask</span>
<span class="sd">    back to the original source resolution after assembly and finalization.</span>

<span class="sd">    Returns:</span>
<span class="sd">        tuple[float, float]: Scaling factors for height and width dimensions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">scale_factors</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">overflow_buffered_source_extents</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">accumulator</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="p">)</span>  <span class="c1"># H, W</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">scale_factors</span><span class="p">)</span>  <span class="c1"># TODO: add tests for this method</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D.setup_memory" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">setup_memory</span><span class="p">(</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="n">accumulator_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">setup_memory</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask_extents</span><span class="p">,</span>
    <span class="n">channels</span><span class="p">,</span>
    <span class="n">accumulator_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overlap_counter_filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">accumulator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_accumulator</span><span class="p">(</span>
        <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="n">accumulator_filepath</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">overlap_counter_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">counter_filepath</span> <span class="o">=</span> <span class="n">overlap_counter_filepath</span>
    <span class="k">elif</span> <span class="n">accumulator_filepath</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">accumulator_filepath</span><span class="o">.</span><span class="n">suffix</span>
        <span class="n">counter_filepath</span> <span class="o">=</span> <span class="n">accumulator_filepath</span><span class="o">.</span><span class="n">with_suffix</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;.overlaps</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">counter_filepath</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">overlap_counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_accumulator</span><span class="p">(</span>
        <span class="n">mask_extents</span><span class="o">=</span><span class="n">mask_extents</span><span class="p">,</span> <span class="n">channels</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="n">counter_filepath</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Use case</strong>: You have high-resolution feature maps from a network and need to:
- Handle masks too large for RAM (using memory-mapped files)
- Automatically scale coordinates from input to output space
- Remove edge artifacts from tiles</p>
<p><strong>Example</strong>: Building attention maps with edge clipping to remove boundary artifacts.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">rationai.explainability.model_probing</span> <span class="kn">import</span> <span class="n">HookedModule</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>

<span class="n">vgg16_model</span> <span class="o">=</span> <span class="n">load_vgg16_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">hooked_model</span> <span class="o">=</span> <span class="n">HookedModule</span><span class="p">(</span><span class="n">vgg16_model</span><span class="p">,</span> <span class="n">layer_name</span><span class="o">=</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>

<span class="c1"># This builder handles coordinate scaling and uses memory-mapped storage</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</span><span class="p">(</span>
    <span class="n">source_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># output resolution per tile</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># for RGB masks</span>
    <span class="n">clip</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>  <span class="c1"># clip 4 pixels from each edge</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">output</span> <span class="o">=</span> <span class="n">vgg16_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># outputs are not used directly</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">hooked_model</span><span class="o">.</span><span class="n">get_activations</span><span class="p">(</span><span class="s2">&quot;backbone.9&quot;</span><span class="p">)</span>  <span class="c1"># shape (B, C, H, W)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">features</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>

<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<hr />
<h3 id="autoscalingscalaruniformvalueconstantstridemaskbuilder">AutoScalingScalarUniformValueConstantStrideMaskBuilder</h3>


<div class="doc doc-object doc-class">



<a id="ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder"></a>
    <div class="doc doc-contents first">
            <p class="doc doc-class-bases">
              Bases: <code><span title="ratiopath.masks.mask_builders.storage.NumpyArrayMaskBuilderAllocatorMixin">NumpyArrayMaskBuilderAllocatorMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.AutoScalingConstantStrideMixin">AutoScalingConstantStrideMixin</span></code>, <code><span title="ratiopath.masks.mask_builders.receptive_field_manipulation.ScalarUniformTiledMaskBuilder">ScalarUniformTiledMaskBuilder</span></code>, <code><span title="ratiopath.masks.mask_builders.aggregation.AveragingMaskBuilderMixin">AveragingMaskBuilderMixin</span></code></p>



        <p>Mask builder combining auto-scaling with scalar uniform tiling.</p>
<p>This builder automatically handles the complete pipeline for building masks from scalar/vector
values when the network output resolution differs from input resolution:
1. Computes output mask dimensions from source image and tile sizes
2. Scales coordinates from input space to output space
3. Compresses representation using GCD of tile extent/stride
4. Expands scalar values into uniform tiles</p>
<p>Typical use case: Neural network produces scalar predictions per input tile, and you want
to create a coverage mask at a different resolution.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>source_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Spatial dimensions of the source image (e.g., (10000, 10000)).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>channels</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Number of channels in scalar predictions.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_tile_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size of input tiles extracted from source (e.g., (512, 512)).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>source_tile_strides</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Stride between input tiles in source space (e.g., (256, 256)).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mask_tile_extents</code>
            </td>
            <td>
                  <code><span title="jaxtyping.Int64">Int64</span>[<span title="ratiopath.masks.mask_builders.mask_builder.AccumulatorType">AccumulatorType</span>, &#39; N&#39;]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Size you want each scalar to represent in output mask (e.g., (64, 64)).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutoScalingScalarUniformValueConstantStrideMaskBuilder</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>
<span class="n">classifier_model</span> <span class="o">=</span> <span class="n">load_classifier_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># load your pretrained model here</span>

<span class="c1"># Build a mask where each scalar prediction covers 64x64 pixels in output</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AutoScalingScalarUniformValueConstantStrideMaskBuilder</span><span class="p">(</span>
    <span class="n">source_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># each scalar value expands to 64x64</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># for multi-class predictions</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
        <span class="n">tiles</span>
    <span class="p">)</span>  <span class="c1"># predictions has shape (B, channels)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>

<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">AutoScalingScalarUniformValueConstantStrideMaskBuilder</span><span class="p">(</span>
    <span class="n">NumpyArrayMaskBuilderAllocatorMixin</span><span class="p">,</span>
    <span class="n">AutoScalingConstantStrideMixin</span><span class="p">,</span>
    <span class="n">ScalarUniformTiledMaskBuilder</span><span class="p">,</span>
    <span class="n">AveragingMaskBuilderMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Mask builder combining auto-scaling with scalar uniform tiling.</span>

<span class="sd">    This builder automatically handles the complete pipeline for building masks from scalar/vector</span>
<span class="sd">    values when the network output resolution differs from input resolution:</span>
<span class="sd">    1. Computes output mask dimensions from source image and tile sizes</span>
<span class="sd">    2. Scales coordinates from input space to output space</span>
<span class="sd">    3. Compresses representation using GCD of tile extent/stride</span>
<span class="sd">    4. Expands scalar values into uniform tiles</span>

<span class="sd">    Typical use case: Neural network produces scalar predictions per input tile, and you want</span>
<span class="sd">    to create a coverage mask at a different resolution.</span>

<span class="sd">    Args:</span>
<span class="sd">        source_extents: Spatial dimensions of the source image (e.g., (10000, 10000)).</span>
<span class="sd">        channels: Number of channels in scalar predictions.</span>
<span class="sd">        source_tile_extents: Size of input tiles extracted from source (e.g., (512, 512)).</span>
<span class="sd">        source_tile_strides: Stride between input tiles in source space (e.g., (256, 256)).</span>
<span class="sd">        mask_tile_extents: Size you want each scalar to represent in output mask (e.g., (64, 64)).</span>

<span class="sd">    Example:</span>
<span class="sd">        ```python</span>
<span class="sd">        import numpy as np</span>
<span class="sd">        import openslide</span>
<span class="sd">        from ratiopath.masks.mask_builders import (</span>
<span class="sd">            AutoScalingScalarUniformValueConstantStrideMaskBuilder,</span>
<span class="sd">        )</span>
<span class="sd">        import matplotlib.pyplot as plt</span>

<span class="sd">        LEVEL = 3</span>
<span class="sd">        tile_extents = (512, 512)</span>
<span class="sd">        tile_strides = (256, 256)</span>
<span class="sd">        slide = openslide.OpenSlide(&quot;path/to/slide.mrxs&quot;)</span>
<span class="sd">        slide_extent_x, slide_extent_y = slide.level_dimensions[LEVEL]</span>
<span class="sd">        classifier_model = load_classifier_model(...)  # load your pretrained model here</span>

<span class="sd">        # Build a mask where each scalar prediction covers 64x64 pixels in output</span>
<span class="sd">        mask_builder = AutoScalingScalarUniformValueConstantStrideMaskBuilder(</span>
<span class="sd">            source_extents=(slide_extent_y, slide_extent_x),</span>
<span class="sd">            source_tile_extents=tile_extents,</span>
<span class="sd">            source_tile_strides=tile_strides,</span>
<span class="sd">            mask_tile_extents=(64, 64),  # each scalar value expands to 64x64</span>
<span class="sd">            channels=3,  # for multi-class predictions</span>
<span class="sd">        )</span>

<span class="sd">        for tiles, xs, ys in generate_tiles_from_slide(</span>
<span class="sd">            slide, LEVEL, tile_extents, tile_strides, batch_size=32</span>
<span class="sd">        ):</span>
<span class="sd">            # tiles has shape (B, C, H, W)</span>
<span class="sd">            predictions = classifier_model.predict(</span>
<span class="sd">                tiles</span>
<span class="sd">            )  # predictions has shape (B, channels)</span>
<span class="sd">            # Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
<span class="sd">            coords_batch = np.stack([ys, xs], axis=0)</span>
<span class="sd">            mask_builder.update_batch(predictions, coords_batch)</span>

<span class="sd">        assembled_mask, overlap = mask_builder.finalize()</span>
<span class="sd">        plt.imshow(assembled_mask[0], cmap=&quot;viridis&quot;, interpolation=&quot;nearest&quot;)</span>
<span class="sd">        plt.axis(&quot;off&quot;)</span>
<span class="sd">        plt.show()</span>
<span class="sd">        ```</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">source_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">source_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
        <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">source_extents</span><span class="o">=</span><span class="n">source_extents</span><span class="p">,</span>
            <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">source_tile_extents</span><span class="p">,</span>
            <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">source_tile_strides</span><span class="p">,</span>
            <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
            <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="ratiopath.masks.mask_builders.AutoScalingScalarUniformValueConstantStrideMaskBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">source_extents</span><span class="p">,</span> <span class="n">source_tile_extents</span><span class="p">,</span> <span class="n">source_tile_strides</span><span class="p">,</span> <span class="n">mask_tile_extents</span><span class="p">,</span> <span class="n">channels</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">


            <details class="mkdocstrings-source">
              <summary>Source code in <code>ratiopath/masks/mask_builders/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">source_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">source_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">source_tile_strides</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">mask_tile_extents</span><span class="p">:</span> <span class="n">Int64</span><span class="p">[</span><span class="n">AccumulatorType</span><span class="p">,</span> <span class="s2">&quot; N&quot;</span><span class="p">],</span>
    <span class="n">channels</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
        <span class="n">source_extents</span><span class="o">=</span><span class="n">source_extents</span><span class="p">,</span>
        <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">source_tile_extents</span><span class="p">,</span>
        <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">source_tile_strides</span><span class="p">,</span>
        <span class="n">mask_tile_extents</span><span class="o">=</span><span class="n">mask_tile_extents</span><span class="p">,</span>
        <span class="n">channels</span><span class="o">=</span><span class="n">channels</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><p><strong>Use case</strong>: Your network outputs scalar predictions per tile, and you want each prediction to represent a fixed-size region in the output mask, automatically handling coordinate scaling.</p>
<p><strong>Example</strong>: Creating a low-resolution classification map where each tile's prediction covers a 6464 region.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">openslide</span>
<span class="kn">from</span> <span class="nn">ratiopath.masks.mask_builders</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">AutoScalingScalarUniformValueConstantStrideMaskBuilder</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">LEVEL</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tile_extents</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
<span class="n">tile_strides</span> <span class="o">=</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
<span class="n">slide</span> <span class="o">=</span> <span class="n">openslide</span><span class="o">.</span><span class="n">OpenSlide</span><span class="p">(</span><span class="s2">&quot;path/to/slide.mrxs&quot;</span><span class="p">)</span>
<span class="n">slide_extent_x</span><span class="p">,</span> <span class="n">slide_extent_y</span> <span class="o">=</span> <span class="n">slide</span><span class="o">.</span><span class="n">level_dimensions</span><span class="p">[</span><span class="n">LEVEL</span><span class="p">]</span>
<span class="n">classifier_model</span> <span class="o">=</span> <span class="n">load_classifier_model</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># Build a mask where each scalar prediction covers 64x64 pixels in output</span>
<span class="n">mask_builder</span> <span class="o">=</span> <span class="n">AutoScalingScalarUniformValueConstantStrideMaskBuilder</span><span class="p">(</span>
    <span class="n">source_extents</span><span class="o">=</span><span class="p">(</span><span class="n">slide_extent_y</span><span class="p">,</span> <span class="n">slide_extent_x</span><span class="p">),</span>
    <span class="n">source_tile_extents</span><span class="o">=</span><span class="n">tile_extents</span><span class="p">,</span>
    <span class="n">source_tile_strides</span><span class="o">=</span><span class="n">tile_strides</span><span class="p">,</span>
    <span class="n">mask_tile_extents</span><span class="o">=</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">),</span>  <span class="c1"># each scalar value expands to 64x64</span>
    <span class="n">channels</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>  <span class="c1"># for multi-class predictions</span>
<span class="p">)</span>

<span class="k">for</span> <span class="n">tiles</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span> <span class="ow">in</span> <span class="n">generate_tiles_from_slide</span><span class="p">(</span>
    <span class="n">slide</span><span class="p">,</span> <span class="n">LEVEL</span><span class="p">,</span> <span class="n">tile_extents</span><span class="p">,</span> <span class="n">tile_strides</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span>
<span class="p">):</span>
    <span class="c1"># tiles has shape (B, C, H, W)</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">classifier_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">tiles</span><span class="p">)</span>  <span class="c1"># predictions has shape (B, channels)</span>
    <span class="c1"># Stack ys and xs into coords_batch with shape (N, B) where N=2 (y, x dimensions)</span>
    <span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">mask_builder</span><span class="o">.</span><span class="n">update_batch</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">coords_batch</span><span class="p">)</span>

<span class="n">assembled_mask</span><span class="p">,</span> <span class="n">overlap</span> <span class="o">=</span> <span class="n">mask_builder</span><span class="o">.</span><span class="n">finalize</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">assembled_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h2 id="choosing-a-mask-builder">Choosing a Mask Builder</h2>
<table>
<thead>
<tr>
<th>Builder</th>
<th>Scalar/Feature Map</th>
<th>Aggregation</th>
<th>Memory</th>
<th>Auto-scaling</th>
<th>Edge Clipping</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AveragingScalarUniformTiledNumpyMaskBuilder</code></td>
<td>Scalar</td>
<td>Average</td>
<td>RAM</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><code>MaxScalarUniformTiledNumpyMaskBuilder</code></td>
<td>Feature Map</td>
<td>Max</td>
<td>RAM</td>
<td>No</td>
<td>No</td>
</tr>
<tr>
<td><code>AutoScalingAveragingClippingNumpyMemMapMaskBuilder2D</code></td>
<td>Feature Map</td>
<td>Average</td>
<td>Disk (memmap)</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr>
<td><code>AutoScalingScalarUniformValueConstantStrideMaskBuilder</code></td>
<td>Scalar</td>
<td>Average</td>
<td>RAM</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody>
</table>
<h2 id="coordinate-system-notes">Coordinate System Notes</h2>
<p>All mask builders expect coordinates in the format <code>(N, B)</code> where:
- <code>N</code> is the number of spatial dimensions (typically 2 for height and width)
- <code>B</code> is the batch size</p>
<p>When using <code>generate_tiles_from_slide()</code>, you'll receive <code>xs</code> and <code>ys</code> arrays. Stack them as:</p>
<div class="highlight"><pre><span></span><code><span class="n">coords_batch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">ys</span><span class="p">,</span> <span class="n">xs</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Shape: (2, B)</span>
</code></pre></div>
<p>Note the order: <code>[ys, xs]</code> not <code>[xs, ys]</code>, as the first dimension represents height (y) and the second represents width (x).</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../../tiling/utils/" class="md-footer__link md-footer__link--prev" aria-label="Previous: utils">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                utils
              </div>
            </div>
          </a>
        
        
          
          <a href="../../parsers/asap/" class="md-footer__link md-footer__link--next" aria-label="Next: ASAPParser">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                ASAPParser
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["announce.dismiss", "content.code.annotate", "content.code.copy", "content.code.select", "content.tooltips", "navigation.indexes", "navigation.sections", "navigation.tabs", "navigation.tabs.sticky", "navigation.footer", "search.highlight", "search.share", "search.suggest", "toc.follow"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>